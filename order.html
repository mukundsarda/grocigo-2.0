<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
  <link rel='stylesheet' href="style.css">
  <title>Order</title>
  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
</head>
<body>
  <div class="topStyle">
    <h2 style="color:ghostwhite;">&nbsp &nbspGrocigo</h2>
    <a class='userNameDisplay'></a>
    <div class="solid"></div>
  </div>
  <div class='sidebar'>
    <button onclick="location.href='customerHome.html'">Home</button>
    <button onclick="location.href='viewProductsCustomer.html'">View Products</button>
    <button onclick="location.href='order.html'">Order</button>
    <button onclick="location.href='cart.html'">Cart</button>
    <button onclick="location.href='customerViewTransactions.html'">My Transactions</button>
    <button id="logoutBtn">Logout</button>
  </div>
  <div class='container'>
    <fieldset><legend><b>Categories</b></legend>
      <table id="categoriesTable"><tr><th>Category ID</th><th>Category Name</th></tr><tbody></tbody></table>
      <form id="catForm">
        <input class='formInputItem' type=text name="catID" placeholder="Enter Category ID" required>
        <input class='goBtn' type=submit value='Go'>
      </form><br><br>
    </fieldset>

    <div id="productsSection" style="display:none;">
      <fieldset><legend><b>Products</b></legend>
        <table id="productsTable"><tr><th>Product ID</th><th>Product Name</th><th>Price</th><th>Stock Left</th></tr><tbody></tbody></table>
        <form id='addToCartForm'>
          <input class='formInputItem' type=text name='productID' placeholder='Enter Product ID' required>
          <input class='formInputItem' type=number min="1" name='quantity' placeholder='Enter Quantity' required>
          <input class='goBtn' type=submit value='Add To Cart'>
        </form>
      </fieldset><br>
    </div>
  </div>
  <script>
    (async () => {
      const uid = await GrocigoUI.requireLoginAndSetUser();
      if (!uid) return;
      const cats = await GrocigoAPI.getCategories();
      GrocigoUI.renderCategoriesTable('#categoriesTable tbody', cats);
    })();
    const productsTable = document.getElementById('productsTable');

    document.getElementById('catForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const catID = new FormData(e.target).get('catID');
      const prods = await GrocigoAPI.getProducts(catID);
      GrocigoUI.renderProductsTable(productsTable, prods);
      document.getElementById('productsSection').style.display = 'block';
    });

    document.getElementById('addToCartForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      try {
        await GrocigoAPI.addToCart({
          product_id: String(fd.get('productID')),
          quantity: Number(fd.get('quantity')),
        });
        alert('Added to Cart');
        const catID = new FormData(document.getElementById('catForm')).get('catID');
        if (catID) {
          const prods = await GrocigoAPI.getProducts(catID);
          GrocigoUI.renderProductsTable(productsTable, prods);
        }
      } catch (err) {
        alert(err.message || 'Failed to add to cart');
      }
    });
    document.getElementById('logoutBtn').onclick = async () => { await GrocigoAPI.logout(); location.href = 'login.html'; };
  </script>
</body>
</html>
